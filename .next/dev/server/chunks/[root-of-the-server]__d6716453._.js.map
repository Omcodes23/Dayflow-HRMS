{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/omvat/OneDrive/Desktop/Dayflow/app/api/auth/register/route.ts"],"sourcesContent":["import { createClient } from '@supabase/supabase-js'\r\nimport { NextRequest, NextResponse } from 'next/server'\r\n\r\nexport async function POST(request: NextRequest) {\r\n  try {\r\n    const body = await request.json()\r\n    const { email, password, name, role } = body\r\n\r\n    const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL\r\n    const supabaseServiceKey = process.env.SUPABASE_SERVICE_KEY || process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY\r\n\r\n    if (!supabaseUrl || !supabaseServiceKey) {\r\n      return NextResponse.json(\r\n        { error: 'Missing Supabase configuration' },\r\n        { status: 500 }\r\n      )\r\n    }\r\n\r\n    // Use service key if available, otherwise use anon key\r\n    const isUsingServiceKey = !!process.env.SUPABASE_SERVICE_KEY\r\n    \r\n    const supabase = createClient(supabaseUrl, supabaseServiceKey, {\r\n      auth: {\r\n        autoRefreshToken: false,\r\n        persistSession: false,\r\n      },\r\n    })\r\n\r\n    let authData: any\r\n    let authError: any\r\n\r\n    if (isUsingServiceKey) {\r\n      // Use admin API if service key is available\r\n      const result = await supabase.auth.admin.createUser({\r\n        email,\r\n        password,\r\n        email_confirm: true,\r\n      })\r\n      authData = result.data\r\n      authError = result.error\r\n    } else {\r\n      // Use regular signUp if only anon key\r\n      const result = await supabase.auth.signUp({\r\n        email,\r\n        password,\r\n      })\r\n      authData = result.data\r\n      authError = result.error\r\n    }\r\n\r\n    if (authError) {\r\n      console.error('Auth error:', authError)\r\n      return NextResponse.json({ error: authError.message }, { status: 400 })\r\n    }\r\n\r\n    if (!authData.user) {\r\n      return NextResponse.json({ error: 'Failed to create user' }, { status: 500 })\r\n    }\r\n\r\n    // Insert user profile with RLS bypass if service key available\r\n    const { data: profileData, error: profileError } = await supabase\r\n      .from('users')\r\n      .insert({\r\n        id: authData.user.id,\r\n        name,\r\n        email,\r\n        role,\r\n        company_id: null,\r\n      })\r\n      .select()\r\n\r\n    if (profileError) {\r\n      console.error('Profile insert error:', profileError)\r\n      \r\n      // If RLS is blocking, try to continue anyway\r\n      if (profileError.code === 'PGRST301' || profileError.message.includes('permission denied')) {\r\n        console.warn('RLS blocking insert, but auth user created successfully')\r\n        // Return success since auth user is created\r\n        return NextResponse.json(\r\n          { \r\n            success: true, \r\n            userId: authData.user.id,\r\n            warning: 'User created but profile insert may be pending'\r\n          },\r\n          { status: 201 }\r\n        )\r\n      }\r\n      \r\n      return NextResponse.json(\r\n        { error: `Failed to create profile: ${profileError.message}` },\r\n        { status: 400 }\r\n      )\r\n    }\r\n\r\n    return NextResponse.json(\r\n      { success: true, userId: authData.user.id, profile: profileData },\r\n      { status: 201 }\r\n    )\r\n  } catch (error) {\r\n    console.error('Register error:', error)\r\n    return NextResponse.json(\r\n      { error: `Internal server error: ${error instanceof Error ? error.message : 'Unknown'}` },\r\n      { status: 500 }\r\n    )\r\n  }\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;AACA;;;AAEO,eAAe,KAAK,OAAoB;IAC7C,IAAI;QACF,MAAM,OAAO,MAAM,QAAQ,IAAI;QAC/B,MAAM,EAAE,KAAK,EAAE,QAAQ,EAAE,IAAI,EAAE,IAAI,EAAE,GAAG;QAExC,MAAM;QACN,MAAM,qBAAqB,QAAQ,GAAG,CAAC,oBAAoB;QAE3D;;QAOA,uDAAuD;QACvD,MAAM,oBAAoB,CAAC,CAAC,QAAQ,GAAG,CAAC,oBAAoB;QAE5D,MAAM,WAAW,IAAA,gMAAY,EAAC,aAAa,oBAAoB;YAC7D,MAAM;gBACJ,kBAAkB;gBAClB,gBAAgB;YAClB;QACF;QAEA,IAAI;QACJ,IAAI;QAEJ,IAAI,mBAAmB;YACrB,4CAA4C;YAC5C,MAAM,SAAS,MAAM,SAAS,IAAI,CAAC,KAAK,CAAC,UAAU,CAAC;gBAClD;gBACA;gBACA,eAAe;YACjB;YACA,WAAW,OAAO,IAAI;YACtB,YAAY,OAAO,KAAK;QAC1B,OAAO;YACL,sCAAsC;YACtC,MAAM,SAAS,MAAM,SAAS,IAAI,CAAC,MAAM,CAAC;gBACxC;gBACA;YACF;YACA,WAAW,OAAO,IAAI;YACtB,YAAY,OAAO,KAAK;QAC1B;QAEA,IAAI,WAAW;YACb,QAAQ,KAAK,CAAC,eAAe;YAC7B,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO,UAAU,OAAO;YAAC,GAAG;gBAAE,QAAQ;YAAI;QACvE;QAEA,IAAI,CAAC,SAAS,IAAI,EAAE;YAClB,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAwB,GAAG;gBAAE,QAAQ;YAAI;QAC7E;QAEA,+DAA+D;QAC/D,MAAM,EAAE,MAAM,WAAW,EAAE,OAAO,YAAY,EAAE,GAAG,MAAM,SACtD,IAAI,CAAC,SACL,MAAM,CAAC;YACN,IAAI,SAAS,IAAI,CAAC,EAAE;YACpB;YACA;YACA;YACA,YAAY;QACd,GACC,MAAM;QAET,IAAI,cAAc;YAChB,QAAQ,KAAK,CAAC,yBAAyB;YAEvC,6CAA6C;YAC7C,IAAI,aAAa,IAAI,KAAK,cAAc,aAAa,OAAO,CAAC,QAAQ,CAAC,sBAAsB;gBAC1F,QAAQ,IAAI,CAAC;gBACb,4CAA4C;gBAC5C,OAAO,gJAAY,CAAC,IAAI,CACtB;oBACE,SAAS;oBACT,QAAQ,SAAS,IAAI,CAAC,EAAE;oBACxB,SAAS;gBACX,GACA;oBAAE,QAAQ;gBAAI;YAElB;YAEA,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,OAAO,CAAC,0BAA0B,EAAE,aAAa,OAAO,EAAE;YAAC,GAC7D;gBAAE,QAAQ;YAAI;QAElB;QAEA,OAAO,gJAAY,CAAC,IAAI,CACtB;YAAE,SAAS;YAAM,QAAQ,SAAS,IAAI,CAAC,EAAE;YAAE,SAAS;QAAY,GAChE;YAAE,QAAQ;QAAI;IAElB,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,mBAAmB;QACjC,OAAO,gJAAY,CAAC,IAAI,CACtB;YAAE,OAAO,CAAC,uBAAuB,EAAE,iBAAiB,QAAQ,MAAM,OAAO,GAAG,WAAW;QAAC,GACxF;YAAE,QAAQ;QAAI;IAElB;AACF"}}]
}